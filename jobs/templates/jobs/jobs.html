{% extends 'base.html' %} {% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-4">üî• Job Board API</h1>
      <p class="lead">Production ready Django DRF</p>
    </div>
  </div>

  <div class="row  mb-5">
    <div class="col">
      <a href="/admin/" class="btn btn-success btn-lg me-2">üõ†Ô∏è Admin Panel</a>
      <a href="/api/jobs/" class="btn btn-info btn-lg me-2">üìä API Docs</a>
      <a href="#" class="btn btn-secondary btn-lg">‚ûï Add Job (soon)</a>
      <br>  

      <div class="btn-group me-2 mt-2 mb-4" role="group">
        <button onclick="showMyJobs()" class="btn btn-success">
          üë§ My Jobs
          <span id="authStatus" class="badge bg-secondary ms-1">?</span>
        </button>
        <button
          onclick="logout()"
          class="btn btn-outline-danger"
          id="logoutBtn"
          style="display: none"
        >
          üö™ Logout
        </button>
      </div>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ My Jobs -->
  <div id="myJobsSection" class="mt-4 mb-3" style="display: none">
    <h3>üéØ My Profile & Jobs</h3>
    <div id="myJobsContent">Loading...</div>
  </div>

  <h3 class="mt-4">üìã Available Jobs:</h3>

  <!-- JWT Login -->
  <div class="mb-4">
    <button class="btn btn-outline-primary" onclick="showLogin()">
      üîê API Login (admin/admin)
    </button>
  </div>

  <!-- Modal -->
  <div id="loginModal" class="modal" style="display: none">
    <div class="modal-content">
      <span onclick="hideLogin()" class="close">&times;</span>
      <h3>üîê Login</h3>
      <input
        id="username"
        type="text"
        class="form-control mb-2"
        value="admin"
        placeholder="Username"
      />
      <input
        id="password"
        type="password"
        class="form-control mb-2"
        value="admin"
        placeholder="Password"
      />
      <button onclick="apiLogin()" class="btn btn-primary w-100">Login</button>
      <div id="tokenResult" class="mt-3"></div>
    </div>
  </div>

  {% if jobs %}
  <div class="row mt-4">
    {% for job in jobs %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ job.title }}</h5>
          <h6 class="card-subtitle text-muted">{{ job.company.name }}</h6>
          <p class="card-text">{{ job.description|truncatewords:15 }}</p>
          <a href="#" class="btn btn-outline-primary btn-sm">View</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info mt-4">
    <h4>üöÄ No jobs yet!</h4>
    <p>Add your first job via <a href="/admin/">Admin Panel</a></p>
  </div>
  {% endif %}
</div>

<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: #0008;
  }
  .modal-content {
    background: #fff;
    margin: 15% auto;
    padding: 20px;
    width: 400px;
    border-radius: 8px;
  }
  .close {
    float: right;
    font-size: 28px;
    cursor: pointer;
  }
</style>

<script>
  function showLogin() {
    document.getElementById("loginModal").style.display = "block";
  }

  function hideLogin() {
    document.getElementById("loginModal").style.display = "none";
  }

  function updateAuthStatus() {
    const token = localStorage.getItem("token");
    const el = document.getElementById("authStatus");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!el) return;

    if (token) {
      el.className = "badge bg-success ms-1";
      el.textContent = "‚úÖ Logged in";
      if (logoutBtn) logoutBtn.style.display = "inline-block";
    } else {
      el.className = "badge bg-danger ms-1";
      el.textContent = "‚ùå Not logged in";
      if (logoutBtn) logoutBtn.style.display = "none";
    }
  }

  async function authGet(url) {
    const token = localStorage.getItem("token");
    const headers = { "Content-Type": "application/json" };
    if (token) {
      headers["Authorization"] = `Bearer ${token}`;
    }
    const res = await fetch(url, { headers });
    return res.json();
  }

  async function apiLogin() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    try {
      const res = await fetch("/api/auth/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      const data = await res.json();

      if (data.access) {
        localStorage.setItem("token", data.access);

        document.getElementById("tokenResult").innerHTML =
          `<div class="alert alert-success">
             ‚úÖ Token saved!
             <br><small>${data.access.slice(0, 30)}...</small>
           </div>`;

        hideLogin();
        updateAuthStatus();
      } else {
        document.getElementById("tokenResult").innerHTML =
          `<div class="alert alert-danger">
             ‚ùå Login failed
           </div>`;
      }
    } catch (err) {
      document.getElementById("tokenResult").innerHTML =
        '<div class="alert alert-danger">‚ùå Error</div>';
    }
  }

  function logout() {
    localStorage.removeItem("token");
    document.getElementById("myJobsSection").style.display = "none";
    updateAuthStatus();
    document.getElementById("logoutBtn").style.display = "none";

    // –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –≤—ã—à–µ–ª
    const content = document.getElementById("myJobsContent");
    if (content) {
      content.innerHTML =
        '<div class="alert alert-info">üîì Logged out successfully</div>';
      document.getElementById("myJobsSection").style.display = "block";
    }
  }

  // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ My Jobs
  async function showMyJobs() {
    const section = document.getElementById("myJobsSection");
    const content = document.getElementById("myJobsContent");
    section.style.display = "block";
    content.innerHTML = '<div class="spinner-border"></div> Loading...';

    try {
      const data = await authGet("/api/jobs/my_jobs/");

      if (!data.is_authenticated) {
        content.innerHTML = `
          <div class="alert alert-warning">
            üîê <strong>Login first!</strong><br>
            <small>Token: ${localStorage.getItem("token") ? "Saved ‚úì" : "Missing"}</small>
          </div>`;
        return;
      }

      content.innerHTML = `
        <div class="alert alert-success mb-3">
          ‚úÖ <strong>${data.username}</strong> (id: ${data.user_id})<br>
          üìß ${data.user_email || "no email"}<br>
          üìä Total jobs: ${data.total_jobs} | Active: ${data.active_jobs}
        </div>`;
    } catch (err) {
      content.innerHTML = '<div class="alert alert-danger">‚ùå API Error</div>';
    }
  }

  document.addEventListener("DOMContentLoaded", updateAuthStatus);
</script>

{% endblock %}
